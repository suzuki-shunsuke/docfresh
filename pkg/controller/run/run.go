package run

import (
	"context"
	_ "embed"
	"fmt"
	"log/slog"
	"strings"
	"text/template"

	"github.com/spf13/afero"
	"github.com/suzuki-shunsuke/slog-error/slogerr"
)

//go:embed command_template.md
var commandTemplate string

type Input struct {
	ConfigFilePath string
	Files          map[string]struct{}
}

type Templates struct {
	Funcs   template.FuncMap
	Command *template.Template
	File    *template.Template
}

func (c *Controller) Run(ctx context.Context, logger *slog.Logger, input *Input) error {
	fns := txtFuncMap()
	cmdTpl, err := template.New("_").Funcs(fns).Parse(commandTemplate)
	if err != nil {
		return fmt.Errorf("parse command template: %w", err)
	}
	tpls := &Templates{
		Command: cmdTpl,
		Funcs:   fns,
	}
	for file := range input.Files {
		logger := logger.With("file", file)
		if err := c.run(ctx, logger, tpls, file); err != nil {
			return slogerr.With(err, "file", file) //nolint:wrapcheck
		}
	}
	return nil
}

func (c *Controller) run(ctx context.Context, _ *slog.Logger, tpls *Templates, file string) error {
	b, err := afero.ReadFile(c.fs, file)
	if err != nil {
		return fmt.Errorf("read a file: %w", err)
	}
	bs := string(b)
	blocks, err := parseFile(string(b))
	if err != nil {
		return fmt.Errorf("parse a file: %w", err)
	}
	var contentBuilder strings.Builder
	for _, block := range blocks {
		s, err := c.renderBlock(ctx, tpls, file, block)
		if err != nil {
			return err
		}
		contentBuilder.WriteString(s)
	}
	content := contentBuilder.String()
	stat, err := c.fs.Stat(file)
	if err != nil {
		return fmt.Errorf("get file info: %w", err)
	}
	if content != bs {
		if err := afero.WriteFile(c.fs, file, []byte(content), stat.Mode()); err != nil {
			return fmt.Errorf("update a file: %w", err)
		}
	}

	return nil
}

type Block struct {
	// text, code block
	Type         string
	Content      string
	Input        *BlockInput
	BeginComment string
	EndComment   string
}

type BlockInput struct {
	Command  *Command
	File     *File
	HTTP     *HTTP
	Template *Template
}

type Template struct {
	Content string
}

type HTTP struct {
	URL string
}

type File struct {
	Path string
}

type Command struct {
	Command    string
	Shell      []string
	IgnoreFail bool `yaml:"ignore_fail,omitempty"`
}

type TemplateInput struct {
	Type string
	// command
	Command        string
	Stdout         string
	Stderr         string
	CombinedOutput string
	ExitCode       int
	// file
	Path    string
	Content string
	// http
	URL string
}
